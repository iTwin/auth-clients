parameters:
  - name: shouldPublish # name of the parameter; required
    type: boolean # data type of the parameter; required

steps:
  - bash: |
      echo "creating pre-bump version snapshot"
      pnpm recursive list --depth -1 --filter "./packages/**" --json > "$(Agent.TempDirectory)/versions-before.txt"

      echo "bumping versions"
      pnpm version-bump

      echo "creating post-bump version snapshot"
      pnpm recursive list --depth -1 --filter "./packages/**" --json > "$(Agent.TempDirectory)/versions-after.txt"

      # outputs vso variables for each package published
      node common/config/azure-pipelines/scripts/determinePublishedPackages.js "$(Agent.TempDirectory)/versions-before.txt" "$(Agent.TempDirectory)/versions-after.txt"
    displayName: Add Release Notes
    name: releaseNotes
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), startsWith(variables['Build.SourceBranch'], 'refs/heads/main'), ${{ parameters.shouldPublish }} )

  - script: pnpm publish-packages --publish -b main
    displayName: Publish packages
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), startsWith(variables['Build.SourceBranch'], 'refs/heads/main'), ${{ parameters.shouldPublish }} )
    env:
      NPM_AUTH_TOKEN: $(npmToken)
