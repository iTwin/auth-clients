parameters:
  - name: shouldPublish # name of the parameter; required
    type: boolean # data type of the parameter; required

steps:
  - bash: |
      echo "creating pre-bump version snapshot"
      node common/scripts/install-run-rush.js list --json > "$(Agent.TempDirectory)/versions-before.txt"

      echo "bumping versions"
      node common/scripts/install-run-rush.js version --bump

      echo "creating post-bump version snapshot"
      node common/scripts/install-run-rush.js list --json > "$(Agent.TempDirectory)/versions-after.txt"

      # outputs vso variables for each package published
      node common/scripts/determinePublishedPackages.js "$(Agent.TempDirectory)/versions-before.txt" "$(Agent.TempDirectory)/versions-after.txt"
    displayName: Add Release Notes
    name: releaseNotes
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), startsWith(variables['Build.SourceBranch'], 'refs/heads/publish'), ${{ parameters.shouldPublish }} )

  - script: node common/scripts/install-run-rush.js publish --publish --include-all -a -b main --set-access-level public
    displayName: rush publish package
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), startsWith(variables['Build.SourceBranch'], 'refs/heads/publish'), ${{ parameters.shouldPublish }} )
    env:
      NPM_AUTH_TOKEN: $(npmToken)
