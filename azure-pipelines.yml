trigger:
- main

pr:
  drafts: false
  branches:
    include:
      - main

resources:
  repositories:
    - repository: build-pipeline-scripts
      type: git
      ref: master
      name: iModelTechnologies/imodeljs-build-pipeline-scripts

stages:
- stage: Build
  displayName: Build
  jobs:
    - job: BuildPackages
      strategy:
        matrix:
          linux:
            imageName: 'ubuntu-latest'
          mac:
            imageName: 'macos-latest'
          windows:
            imageName: 'windows-latest'
      pool:
        vmImage: $(imageName)
      steps:
      - script: npm install -g pnpm
        displayName: 'Install pnpm'

      - script: pnpm install
        displayName: 'Install dependencies'

      - script: pnpm run build
        displayName: 'Build'

      - script: pnpm run lint
        displayName: 'Lint'

      - script: pnpm run cover
        displayName: 'cover'

      - template: ./publish-test-results.yaml

      - bash: |
          pnpm run pack
        displayName: 'pnpm run pack'

      # publish artifact

      - bash: |
          BrowserAuthVer=$(node -p "require('./packages/browser/package.json').version")
          BrowserAuthName=$(node -p "require('./packages/browser/package.json').name")
          ServiceAuthVer=$(node -p "require('./packages/service/package.json').version")
          ServiceAuthName=$(node -p "require('./packages/service/package.json').name")
          ElectronAuthVer=$(node -p "require('./packages/electron/package.json').version")
          ElectronAuthName=$(node -p "require('./packages/electron/package.json').name")
          oidcSignInToolVer=$(node -p "require('./packages/oidc-signin-tool/package.json').version")
          oidcSignInToolName=$(node -p "require('./packages/oidc-signin-tool/package.json').name")

          checkVer() {
            localVer=$1
            name=$2

            remoteVer=$(npm view $name version)
            if [ -z "$remoteVer" ]; then
              remoteVer=0.0.0
            fi

            olderVer=$(printf '%s\n' "$localVer" "$remoteVer" | sort -V | head -n1)
            if [ "$localVer" != "$remoteVer" ] && [ "$remoteVer" = "$olderVer" ]; then
              echo true
            else
              echo false
            fi
          }

          updateBrowser=$(checkVer $BrowserAuthVer $BrowserAuthName)
          updateService=$(checkVer $ServiceAuthVer $ServiceAuthName)
          updateOidcSignInTool=$(checkVer $oidcSignInToolVer $oidcSignInToolName)
          updateElectron=true

          if [ "$updateBrowser" = "true" ] && [ "$updateBrowser" = "$updateService" ] && [ "$BrowserAuthVer" = "$ServiceAuthVer" ]; then
            echo "Auth package publishing conditions are met."
            shouldPublishAuthClients=true
          else
            echo "Auth package publishing conditions not met."
            shouldPublishAuthClients=false
          fi

          if [ "$updateOidcSignInTool" = "true" ]; then
            echo "Oidc-signin-tool package publishing conditions are met."
            shouldPublishSignInTool=true
          else
            echo "Oidc-signin-tool package publishing conditions not met."
            shouldPublishSignInTool=false
          fi

          if [ "$updateElectron" = "true" ]; then
            echo "Electron Auth package publishing conditions are met."
            shouldPublishElectronAuthClient=true
          else
            echo "Electron Auth package publishing conditions not met."
            shouldPublishElectronAuthClient=false
          fi

          echo "##vso[task.setvariable variable=shouldPublishAuthClients;isOutput=true]$shouldPublishAuthClients"
          echo "##vso[task.setvariable variable=shouldPublishSignInTool;isOutput=true]$shouldPublishSignInTool"
          echo "##vso[task.setvariable variable=shouldPublishElectronAuthClient;isOutput=true]$shouldPublishElectronAuthClient"
          echo "##vso[task.setvariable variable=BrowserAuthVer;isOutput=true]$BrowserAuthVer"
          echo "##vso[task.setvariable variable=BrowserAuthName;isOutput=true]$BrowserAuthName"
          echo "##vso[task.setvariable variable=ServiceAuthVer;isOutput=true]$ServiceAuthVer"
          echo "##vso[task.setvariable variable=ServiceAuthName;isOutput=true]$ServiceAuthName"
          echo "##vso[task.setvariable variable=ElectronAuthVer;isOutput=true]$ElectronAuthVer"
          echo "##vso[task.setvariable variable=ElectronAuthName;isOutput=true]$ElectronAuthName"
          echo "##vso[task.setvariable variable=oidcSignInToolVer;isOutput=true]$oidcSignInToolVer"
          echo "##vso[task.setvariable variable=oidcSignInToolName;isOutput=true]$oidcSignInToolName"

        displayName: 'Store Build Info'
        name: info
        condition: and(succeeded(), eq(variables.try_publish, true), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Agent.OS'], 'Linux'))

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/packages/browser/itwin-browser-authorization-$(info.BrowserAuthVer).tgz'
          artifactName: BrowserAuthorizationClient
        displayName: 'Publish Browser Auth'
        condition: and(succeeded(), eq(variables['info.shouldPublishAuthClients'], 'true'))

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/packages/service/itwin-service-authorization-$(info.ServiceAuthVer).tgz'
          artifactName: ServiceAuthorizationClient
        displayName: 'Publish Service Auth'
        condition: and(succeeded(), eq(variables['info.shouldPublishAuthClients'], 'true'))

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/packages/electron/itwin-electron-authorization-$(info.ElectronAuthVer).tgz'
          artifactName: ElectronAuthorizationClient
        displayName: 'Publish Electron Auth'
        condition: and(succeeded(), eq(variables['info.shouldPublishElectronAuthClient'], 'true'))

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.SourcesDirectory)/packages/oidc-signin-tool/itwin-oidc-signin-tool-$(info.oidcSignInToolVer).tgz'
          artifactName: OIDCSignInTool
        displayName: 'Publish OIDC Sign In Tool'
        condition: and(succeeded(), eq(variables['info.shouldPublishSignInTool'], 'true'))

- stage: Publish_Auth_Clients
  displayName: Publish Auth Clients
  condition: and(succeeded(), eq(dependencies.Build.outputs['BuildPackages.linux.info.shouldPublishAuthClients'], 'true'))
  dependsOn: Build

  jobs:
    - template: templates/npmjs-publish-deployment.yaml@build-pipeline-scripts
      parameters:
        path: '*.tgz'
        artifactName: BrowserAuthorizationClient
        name: BrowserAuthorizationClient
    - template: templates/npmjs-publish-deployment.yaml@build-pipeline-scripts
      parameters:
        path: '*.tgz'
        artifactName: ServiceAuthorizationClient
        name: ServiceAuthorizationClient

- stage: Publish_Oidc_Sign_In_Tool
  displayName: Publish OIDC Sign In Tool
  condition: and(succeeded(), eq(dependencies.Build.outputs['BuildPackages.linux.info.shouldPublishSignInTool'], 'true'))
  dependsOn: Build

  jobs:
    - template: templates/npmjs-publish-deployment.yaml@build-pipeline-scripts
      parameters:
        path: '*.tgz'
        artifactName: OIDCSignInTool
        name: OIDCSignInTool

- stage: Publish_Electron_Auth_Client
  displayName: Publish Electron Auth Client
  condition: and(succeeded(), eq(dependencies.Build.outputs['BuildPackages.linux.info.shouldPublishElectronAuthClient'], 'true'))
  dependsOn: Build

  jobs:
    - template: templates/npmjs-publish-deployment.yaml@build-pipeline-scripts
      parameters:
        path: '*.tgz'
        artifactName: ElectronAuthorizationClient
        name: ElectronAuthorizationClient
